<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.org">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="tutorial.css">
<TITLE>Tutorial 2.1: Linux Kernel - Obtendo os fontes e compilando com ajuda do Buildroot (v1.2)</TITLE>
</HEAD><BODY BGCOLOR="white" TEXT="black">
<CENTER>
<H1>Tutorial 2.1: Linux Kernel - Obtendo os fontes e compilando com ajuda do Buildroot (v1.2)</H1>
</CENTER>

<P></P>
<HR NOSHADE SIZE=1>
<P></P>

  <OL>
  <LI><A HREF="#toc1">Objetivo</A>
  <LI><A HREF="#toc2">Obtendo um novo Kernel</A>
  <LI><A HREF="#toc3">Configurar o Buildroot para o novo kernel</A>
    <UL>
    <LI><A HREF="#toc4">3.1. Criar um arquivo de configuração customizado para o kernel</A>
    </UL>
  <LI><A HREF="#toc5">Compilação</A>
    <UL>
    <LI><A HREF="#toc6">4.1. Compilando alterações no Kernel</A>
    <LI><A HREF="#toc7">4.2. Alterações de configuração através do menuconfig do Linux</A>
    </UL>
  </OL>

<P></P>
<HR NOSHADE SIZE=1>
<P></P>

<A NAME="toc1"></A>
<H1>1. Objetivo</H1>

<P>
O objetivo deste tutorial é permitir ao aluno gerar uma distribuição Linux com uma determinada versão de kernel obtida de outros repositórios, que não o repositório padrão do Buildroot. Isso é importante quando deseja-se
utilizar uma versão de kernel não suportada pelo Buildroot, quando deseja-se modificar o kernel ou adicionar novos drivers. 
</P>

<A NAME="toc2"></A>
<H1>2. Obtendo um novo Kernel</H1>

<P>
Oficialmente, o kernel Linux é mantido em kernel.org. Neste local, é possível encontrar a versões <I>vanila</I> do kernel, ou seja, versões oficiais sem nenhuma modificação extra. É comum que desenvolvedores, ou empresas, matenham <I>branches</I>
do repositório oficial em seus servidores. Isso acontece porque modificações no kernel precisam ser avaliadas e aprovadas pelos mantenedores, sendo que, nem sempre novas funcionalidades são prontamente aceitas. Por exemplo, o suporte
a um novo processador, implementado por empresas como NXP, Maxim e Intel pode ser disponibilizado para o público mas não suportado no repositório oficial. 
</P>
<P>
Em nossas aulas, obteremos uma versão oficial <I>vanila</I> do kernel, a manteremos em nossos repositórios e a modifcaremos conforme nossas necessidades. É importante que todos usem a mesma versão 4.13.9, pois todos os tutoriais foram baseados nela. 
</P>
<P>
Primeiramente faça download desta versão do kernel.org para dentro do seu diretório de trabalho MATRICULA/. É necessário utilizar a mesma versão do <I>Buildroot</I> dos tutoriais passados.
</P>

<PRE>
  $ wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.13.9.tar.xz
</PRE>

<P>
Agora, iremos descompactar e versionar os fontes do kernel. Primeiramente descompacte o <I>tarball</I>.
</P>

<PRE>
  $ tar -xvf linux-4.13.9.tar.xz
</PRE>

<P>
Se você não desejar manter um repositório remoto essa parte pode ser ignorada. No entanto, deve-se exportar uma variável de ambiente (LINUX_OVERRIDE_SRCDIR) como explicado adiante. 
</P>
<P>
Com o objetivo de manter um repositório em um servidor remoto, deve-se inicializar o repositório de fontes local. No diretório dos fontes do kernel faça:
</P>

<PRE>
  $ git init
  $ git add .
  $ git commit -m "First commit"
</PRE>

<P>
Inicialize o repositório de fontes remoto:
</P>

<PRE>
  $ git remote add &lt;nome_do_repositório&gt; &lt;url_do_repositório&gt;
</PRE>

<P>
Se o repositório ainda não existe remotamente, crie ele agora. Depois, basta continuar com a inicialização:
</P>

<PRE>
  $ git push &lt;nome_do_repositório&gt; master:master
</PRE>

<A NAME="toc3"></A>
<H1>3. Configurar o Buildroot para o novo kernel</H1>

<P>
É recomendado que os fontes do <I>Buildroot</I> sejam extraídos novamente, ou a configuração limpa completamente. No diretório do <I>Buildroot</I> prepare a configuração:
</P>

<PRE>
  $ make qemu_x86_defconfig
  $ make menuconfig
</PRE>

<P>
Navegue nos menus, conforme mostrado abaixo, apague a opção de DHCP.
</P>

<PRE>
    System configuration  ---&gt; 
    	 ()  Network interface to configure through DHCP
</PRE>

<PRE>
    Kernel ---&gt; 
    	 (4.13.9) Kernel version   ---
</PRE>

<P>
É muito <B>importante</B> que, durante a geração das bibliotecas do sistema, seja usado a versão correta dos headers do kernel. Configure o Buildroot conforme indicado abaixo:
</P>

<PRE>
  Toolchain  ---&gt; 
  	Custom kernel headers series (4.13.x)  ---&gt; 
</PRE>

<P>
Agora, será necessário recompilar toda a distribuição. Isso será realizado ao final do tutorial.
</P>

<A NAME="toc4"></A>
<H2>3.1. Criar um arquivo de configuração customizado para o kernel</H2>

<P>
O Buildroot configura o kernel a partir de um arquivo pré-definido. Através dos menus do Buildroot é possível ver e alterar tal arquivo:
</P>

<PRE>
  Kernel  ---&gt;
  	(board/qemu/x86/linux.config) Configuration file path
  
</PRE>

<P>
Iremos gerar um novo arquivo de configuração customizado para o kernel baseado no arquivo original (linux-4.11.config). Para isso, copie o arquivo citado para dentro do fontes do kernel, conforme comando abaixo:
</P>

<PRE>
  $ cp buildroot/board/qemu/x86/linux.config linux-4.13.9/arch/x86/configs/qemu_x86_custom_defconfig
</PRE>

<P>
<B>Nota:</B> Não se esqueça de comitar as alterações no repositório do kernel. O arquivo qemu_x86_custom_defconfig também deverá estar presente na cópia do kernel mantida pelo buildroot.
</P>
<P>
Agora, configure o Buildroot para utilizar o novo arquivo de configuração:
</P>

<PRE>
  Kernel  ---&gt; 
  	Kernel configuration (Using an in-tree defconfig file)  ---&gt;
  	(qemu_x86_custom) Defconfig name 
</PRE>

<A NAME="toc5"></A>
<H1>4. Compilação</H1>

<P>
Agora iremos recompilar toda a distribuição. Naturalmente, o Buildroot buscará os fontes do kernel no repositório da núvem, conforme configurado anteriormente.
Contudo, muitas vezes queremos testar nossas alterações no kernel antes de realizar um commit. É possível configurar o Buildroot para 
buscar os fontes em um diretório de fontes local, em compilações posteriores. Para isso, precisamos configurar a variável de ambiente <I>LINUX_OVERRIDE_SRCDIR</I>
para indicar o local dos fontes. Por exemplo:
</P>

<PRE>
  $ export LINUX_OVERRIDE_SRCDIR=~/MATRICULA/linux-4.13.9/
</PRE>

<P>
O comando <I>export</I> deve ser executado no mesmo console onde será compilado o Buildroot. A configuração será perdida ao fechar o console.
</P>
<P>
Recompile toda a distribuição:
</P>

<PRE>
  $ make clean
  $ make
</PRE>

<P>
Se o comando falhar em função de algum problema com um certificado de segurança, execute novamente o comando make menuconfig para reconfigurar o Buildroot. Dessa vez, modifique os parâmetros passados ao comando wget adicionando a flag --no-check-certificate no menu Build options -&gt; Commands -&gt; Wget.
</P>
<P>
Para emular o a imagem e o sistema de arquivos, utilize:
</P>

<PRE>
  qemu-system-i386 --kernel output/images/bzImage --hda output/images/rootfs.ext2 --nographic --append "console=ttyS0 root=/dev/sda"
</PRE>

<A NAME="toc6"></A>
<H2>4.1. Compilando alterações no Kernel</H2>

<P>
O Buildroot faz uma cópia da árvore de fontes do kernel para o diretório <I>buildroot/output/build/linux-custom</I>. Caso sejam realizadas 
alterações na árvore de fontes, o Buildroot não irá recompilar o kernel, pois a árvore de fontes é copiada apenas na primeira compilação após o 
<I>make clean</I>. Contudo, podemos forçar que o Builtroot pegue uma nova cópia dos fontes. Para isso, apague os arquivos indicados abaixo:
</P>

<PRE>
  $ rm output/build/linux-custom/.stamp_*
</PRE>

<P>
Após, execute o comando <I>make</I>.
</P>
<P>
O Buildroot usa os arquivos <I>.stamp_</I> para indicar quais procedimentos foram realizados em cada diretório de fontes. Isso torna possível recomeçar uma compilação do ponto onde ela foi interrompida. 
No caso acima, estamos informando ao buildroot que ele precisa extrair, configurar e compilar o kernel. Os outros pacotes não precisaram ser recompilados. 
</P>

<A NAME="toc7"></A>
<H2>4.2. Alterações de configuração através do menuconfig do Linux</H2>

<P>
Caso seja realizada alguma configuração no menuconfig do Linux através do Buildroot (<I>make linux-menuconfig</I>), será necessário
copiar o <I>.config</I> para o arquivo <I>qemu_x86_custom_defconfig</I> na árvore de fontes do kernel. Por exemplo:
</P>

<PRE>
  $ cp buildroot/output/build/linux-custom/.config linux-4.13.9/arch/x86/configs/qemu_x86_custom_defconfig 
</PRE>

<P>
Agora é possível comitar as alterações no reposítorio do kernel. 
</P>

<!-- html code generated by txt2tags 2.6 (http://txt2tags.org) -->
<!-- cmdline: txt2tags 1.1 - buildroot.txt 1.2 - qemu-network.txt 1.3 - iperf.txt 2.1 - kernel_tutorial.txt 2.2 - system_call.txt 2.3 - driver_hello_world.txt 2.4 - iosched.txt 3.1 - ftrace.txt 3.2 - ftrace2.txt 3.3 - trace-cmd_kernelshark.txt 3.4 - sched_low_idle_not_used.txt 4.1 - memory_tools.txt 4.2 - process_segments.txt -->
</BODY></HTML>
